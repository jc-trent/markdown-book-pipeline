% ============================================================
% book.tex — LaTeX template for The Red Cloth series
% 6×9 trade paperback, Palatino, memoir class
%
% Used by build_pdf.py via pandoc --template=book.tex
% ============================================================

\documentclass[11pt,openany,extrafontsizes]{memoir}

% ── Page Geometry ──────────────────────────────────────────
% 6×9 stock; margins tuned for KDP at ~350–400 pages
\setstocksize{9in}{6in}
\settrimmedsize{9in}{6in}{*}
\settrims{0pt}{0pt}

% Margins: inside (gutter) is larger for binding
\setlrmarginsandblock{0.75in}{0.5in}{*}   % inside / outside
\setulmarginsandblock{0.7in}{0.75in}{*}    % top / bottom
\setheadfoot{14pt}{26pt}                    % header height / footer height
\setheaderspaces{*}{10pt}{*}                % space above header

\checkandfixthelayout

% ── Fonts ──────────────────────────────────────────────────
\usepackage{fontspec}
\setmainfont{Palatino}[                     % macOS system font
    Ligatures=TeX,
]
\setmonofont{Courier New}[                  % macOS system font for military docs
    Scale=MatchLowercase,
]

% ── Typography ─────────────────────────────────────────────
\usepackage{microtype}                      % Subtle spacing improvements
\frenchspacing                              % Single space after periods

% Paragraph formatting
\setlength{\parindent}{1.5em}
\abnormalparskip{0pt}

% ── Language ───────────────────────────────────────────────
\usepackage{polyglossia}
\setdefaultlanguage[variant=american]{english}

% ── Headers and Footers ────────────────────────────────────
% Default page style: book title left, chapter title right
\makepagestyle{bookstyle}
\makeevenhead{bookstyle}{\thepage}{}{\small\itshape $title$}
\makeoddhead{bookstyle}{\small\itshape\leftmark}{}{\thepage}
\makeevenfoot{bookstyle}{}{}{}
\makeoddfoot{bookstyle}{}{}{}

% Chapter opening pages: page number centered at bottom, no header
\makepagestyle{chapter}
\makeevenhead{chapter}{}{}{}
\makeoddhead{chapter}{}{}{}
\makeevenfoot{chapter}{}{\thepage}{}
\makeoddfoot{chapter}{}{\thepage}{}

\pagestyle{bookstyle}
\aliaspagestyle{title}{empty}

% ── Chapter Style ──────────────────────────────────────────
% Headings already contain "Chapter N: Title" or "Prologue" etc.
% So we suppress memoir's auto "Chapter N" prefix entirely.
\makechapterstyle{redcloth}{%
    \chapterstyle{default}
    \setlength{\beforechapskip}{48pt}
    \setlength{\afterchapskip}{24pt}
    \renewcommand*{\chaptitlefont}{\normalfont\Large\itshape\centering}
    % Suppress all chapter number printing
    \renewcommand*{\printchaptername}{}
    \renewcommand*{\chapternamenum}{}
    \renewcommand*{\printchapternum}{}
    \renewcommand*{\afterchapternum}{}
    \renewcommand*{\printchapternonum}{}
}
\chapterstyle{redcloth}

% Suppress chapter numbering globally
\setsecnumdepth{part}

% ── Scene Breaks ───────────────────────────────────────────
\newcommand{\scenebreak}{%
    \par\vspace{12pt}%
    \noindent\hfil\rule{0.25\textwidth}{0.4pt}\hfil%
    \par\vspace{12pt}%
    \noindent\ignorespaces%
}

% No-indent after scene breaks is handled by \noindent\ignorespaces in \scenebreak

% ── Block Quotes ───────────────────────────────────────────
% Pandoc uses the quote environment
\renewenvironment{quote}{%
    \list{}{%
        \rightmargin=1em
        \leftmargin=1em
    }%
    \item\relax\itshape
}{%
    \endlist
}

% ── Epigraph Support ───────────────────────────────────────
\newenvironment{bookepigraph}{%
    \thispagestyle{empty}
    \vspace*{2.5in}
    \begin{center}
    \itshape
}{%
    \end{center}
    \clearpage
}

% ── Front Matter Environments ──────────────────────────────
\newenvironment{titlepage-content}{%
    \thispagestyle{empty}
    \vspace*{2.5in}             % Push title to roughly 1/3 down the page
    \begin{center}
}{%
    \end{center}
    \clearpage
}

\newenvironment{frontsection}{%
    \thispagestyle{empty}
    \vspace*{2.5in}
    \begin{center}
}{%
    \end{center}
    \clearpage
}

\newenvironment{military-doc}{%
    \par\vspace{6pt}
    \begin{adjustwidth}{0.5em}{0.5em}
    \ttfamily\small
    \setlength{\parskip}{2pt}
    \setlength{\parindent}{0pt}
}{%
    \end{adjustwidth}
    \par\vspace{6pt}
}

% Straight quotes for military docs (Courier doesn't render curly quotes well)
\renewcommand{\textquotesingle}{\char39}
\renewcommand{\textquotedbl}{\char34}

% ── Centered Attribution ───────────────────────────────────
\newenvironment{attrib}{%
    \begin{center}\small
}{%
    \end{center}
}

% ── Utilities ──────────────────────────────────────────────
\usepackage[normalem]{ulem}                 % For strikethrough if needed
\usepackage{graphicx}
\usepackage{longtable,booktabs}
\usepackage{calc}

% Tight list support (pandoc)
\providecommand{\tightlist}{%
    \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}%
}

% Pandoc scaling for images
$if(graphics)$
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
$endif$

% Hyperref (last, as usual)
\usepackage[hidelinks]{hyperref}
\hypersetup{
    pdftitle={$title$},
    pdfauthor={$author$},
    pdflang={$lang$},
}

% ============================================================
% Document
% ============================================================

\begin{document}

\frontmatter
\pagestyle{empty}

% ── Title Page ─────────────────────────────────────────────
\thispagestyle{empty}
\vspace*{2.5in}
\begin{center}
{\HUGE\bfseries $title$\par}
\vspace{12pt}
{\large $author$\par}
$if(series)$
\vspace{8pt}
{$series$}
$endif$
\end{center}
\clearpage

$body$

\end{document}